name: Build Walrio GUIs

on:
  # Temporarily enable for all PR events to test and fix build issues
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write
  actions: read

jobs:
  build:
    # Temporarily run on all triggers to test and fix build process
    
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        gui-variant: ['main', 'lite']
    
    runs-on: ${{ matrix.os }}
    
    env:
      PYTHON_VERSION: '3.11'  # Fixed Python version for all builds
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
      # Only needed for non-Windows
      if: runner.os != 'Windows'
        
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    # Install GStreamer using system package managers
    - name: Install GStreamer (Linux)
      if: runner.os == 'Linux'
      run: |
        echo "Installing GStreamer for Linux..."
        sudo apt update
        sudo apt install -y gstreamer1.0-plugins-base gstreamer1.0-plugins-good gstreamer1.0-plugins-ugly gstreamer1.0-plugins-bad python3-gi gir1.2-gstreamer-1.0

    - name: Install GStreamer (macOS)
      if: runner.os == 'macOS'
      run: |
        echo "Installing GStreamer for macOS..."
        brew update
        brew install gstreamer pygobject3

    - name: Install GStreamer (Windows)
      if: runner.os == 'Windows'
      uses: msys2/setup-msys2@v2
      with:
        update: true
        install: >-
          mingw-w64-x86_64-gstreamer
          mingw-w64-x86_64-python-gobject

    - name: Comprehensive GStreamer verification (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        echo "=== Comprehensive GStreamer/PyGObject Verification ==="
        
        # Print environment variables
        echo "Environment variables:"
        echo "  GST_PLUGIN_PATH: ${GST_PLUGIN_PATH:-Not set}"
        echo "  GI_TYPELIB_PATH: ${GI_TYPELIB_PATH:-Not set}"
        echo "  PKG_CONFIG_PATH: ${PKG_CONFIG_PATH:-Not set}"
        
        # Test basic Python imports
        echo "Testing Python gi import..."
        python -c "import sys; print('Python version:', sys.version)"
        
        echo "Testing PyGObject import..."
        python -c "import gi; print('SUCCESS: gi import successful')" || echo "ERROR: gi import failed"
        
        echo "Testing GStreamer import..."
        python -c "import gi; gi.require_version('Gst', '1.0'); from gi.repository import Gst; print('SUCCESS: GStreamer import successful')" || echo "ERROR: GStreamer import failed"
        
        echo "Testing GStreamer initialization..."
        python -c "import gi; gi.require_version('Gst', '1.0'); from gi.repository import Gst; result = Gst.init_check(None); print('SUCCESS: GStreamer initialization successful' if result else 'WARNING: GStreamer initialization failed')" || echo "ERROR: GStreamer initialization test failed"
        
        echo "Verification completed."
        
    - name: Comprehensive GStreamer verification (Windows)
      if: runner.os == 'Windows'
      shell: msys2 {0}
      run: |
        echo "=== Windows GStreamer/PyGObject Verification ==="
        export PKG_CONFIG_PATH="/mingw64/lib/pkgconfig"
        export GI_TYPELIB_PATH="/mingw64/lib/girepository-1.0"
        export GST_PLUGIN_PATH="/mingw64/lib/gstreamer-1.0"
        echo "Environment variables:"
        echo "  GST_PLUGIN_PATH: $GST_PLUGIN_PATH"
        echo "  GI_TYPELIB_PATH: $GI_TYPELIB_PATH"
        echo "  PKG_CONFIG_PATH: $PKG_CONFIG_PATH"
        echo "Testing Python gi import..."
        python -c "import sys; print('Python version:', sys.version)"
        echo "Testing PyGObject import..."
        python -c "import gi; print('SUCCESS: gi import successful')" || echo "ERROR: gi import failed"
        echo "Testing GStreamer import..."
        python -c "import gi; gi.require_version('Gst', '1.0'); from gi.repository import Gst; print('SUCCESS: GStreamer import successful')" || echo "ERROR: GStreamer import failed"
        echo "Testing GStreamer initialization..."
        python -c "import gi; gi.require_version('Gst', '1.0'); from gi.repository import Gst; result = Gst.init_check(None); print('SUCCESS: GStreamer initialization successful' if result else 'WARNING: GStreamer initialization failed')" || echo "ERROR: GStreamer initialization test failed"
        echo "Windows verification completed."
        
    - name: Install Python dependencies (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        python -m pip install --upgrade pip
        pip install mutagen PySide6 Pillow
        pip install pyinstaller
    - name: Install Python dependencies (Windows)
      if: runner.os == 'Windows'
      shell: msys2 {0}
      run: |
        python -m pip install --upgrade pip
        pip install mutagen PySide6 Pillow
        pip install pyinstaller
        



        
    - name: Run dependency check
      continue-on-error: true
      run: |
        make deps-check
      shell: bash
      if: runner.os != 'Windows'
    - name: Run dependency check (Windows)
      continue-on-error: true
      shell: msys2 {0}
      if: runner.os == 'Windows'
      run: |
        python .github/scripts/deps_check.py
    - name: Build GUI (${{ matrix.gui-variant }})
      if: runner.os != 'Windows'
      run: |
        make build-${{ matrix.gui-variant }}
    - name: Build GUI (${{ matrix.gui-variant }}) [Windows]
      if: runner.os == 'Windows'
      shell: msys2 {0}
      run: |
        echo "Building GUI with MSYS2 Python..."
        python .github/scripts/build_gui.py --gui ${{ matrix.gui-variant }} --clean
    - name: Test built executable (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        # Test that the specific executable was created
        VARIANT="${{ matrix.gui-variant }}"
        if [ "$VARIANT" = "main" ]; then
          EXPECTED_FILE="dist/WalrioMain"
        else
          EXPECTED_FILE="dist/WalrioLite"
        fi
        
        if [ -f "$EXPECTED_FILE" ]; then
          echo "SUCCESS: $EXPECTED_FILE found"
        else
          echo "ERROR: $EXPECTED_FILE not found"
          ls -la dist/ || echo "dist/ directory not found"
          exit 1
        fi
        
    - name: Test built executable (Windows)
      if: runner.os == 'Windows'
      shell: msys2 {0}
      run: |
        variant="${{ matrix.gui-variant }}"
        if [ "$variant" = "main" ]; then
          expectedFile="dist/WalrioMain.exe"
        else
          expectedFile="dist/WalrioLite.exe"
        fi
        if [ -f "$expectedFile" ]; then
          echo "SUCCESS: $expectedFile found"
        else
          echo "ERROR: $expectedFile not found"
          ls -la dist/ || echo "dist/ directory not found"
          exit 1
        fi
    - name: Test PyGObject bundling (Linux/macOS)
      if: runner.os != 'Windows'
      continue-on-error: true
      shell: bash
      run: |
        echo "Testing PyGObject import capability in built environment..."
        if python -c "import gi; print('SUCCESS: gi import successful')"; then
          echo "SUCCESS: PyGObject available in build environment"
        else
          echo "WARNING: PyGObject not available in build environment - executable may have import issues"
        fi
        if python -c "import gi; gi.require_version('Gst', '1.0'); from gi.repository import Gst; print('SUCCESS: GStreamer import successful')"; then
          echo "SUCCESS: GStreamer available in build environment"
        else
          echo "WARNING: GStreamer not available in build environment - audio may not work"
        fi

    - name: Test PyGObject bundling (Windows)
      if: runner.os == 'Windows'
      continue-on-error: true
      shell: msys2 {0}
      run: |
        echo "Testing PyGObject import capability in built environment (MSYS2 Python)..."
        if python -c "import gi; print('SUCCESS: gi import successful')"; then
          echo "SUCCESS: PyGObject available in build environment"
        else
          echo "WARNING: PyGObject not available in build environment - executable may have import issues"
        fi
        if python -c "import gi; gi.require_version('Gst', '1.0'); from gi.repository import Gst; print('SUCCESS: GStreamer import successful')"; then
          echo "SUCCESS: GStreamer available in build environment"
        else
          echo "WARNING: GStreamer not available in build environment - audio may not work"
        fi
        
    - name: Create artifact name
      id: artifact
      run: |
        OS_NAME="${{ runner.os }}"
        if [ "$OS_NAME" = "Linux" ]; then
          OS_NAME="linux"
        elif [ "$OS_NAME" = "Windows" ]; then
          OS_NAME="windows"  
        elif [ "$OS_NAME" = "macOS" ]; then
          OS_NAME="macos"
        fi
        
        VARIANT="${{ matrix.gui-variant }}"
        VARIANT_UPPER=$(echo "$VARIANT" | tr '[:lower:]' '[:upper:]')
        
        echo "name=WALRIO_${VARIANT_UPPER}-${OS_NAME}" >> $GITHUB_OUTPUT
      shell: bash

    - name: Update build completion status
      if: github.event_name == 'issue_comment'
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const issueNumber = context.issue.number;
          const runId = '${{ github.run_id }}';
          const variant = '${{ matrix.gui-variant }}';
          const os = '${{ matrix.os }}';
          const artifactName = '${{ steps.artifact.outputs.name }}';
          
          const message = `âœ… **Build completed for ${variant} on ${os}**
          
          ðŸ“¦ Successfully built Walrio ${variant} GUI for ${os}
          
          ï¿½ **Artifact**: \`${artifactName}\`
          ðŸ”— **[Download from Actions](https://github.com/${owner}/${repo}/actions/runs/${runId})**
          
          *This build is complete and artifacts are ready for download.*`;
          
          await github.rest.issues.createComment({
            owner,
            repo,
            issue_number: issueNumber,
            body: message
          });

    - name: Comment on build failure
      if: failure() && github.event_name == 'issue_comment'
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const issueNumber = context.issue.number;
          const runId = '${{ github.run_id }}';
          const variant = '${{ matrix.gui-variant }}';
          const os = '${{ matrix.os }}';
          
          const message = `âŒ **Build failed for ${variant} on ${os}**
          
          ðŸ’¥ Failed to build Walrio ${variant} GUI for ${os}
          
          ðŸ” **[View error logs](https://github.com/${owner}/${repo}/actions/runs/${runId})**
          
          *Please check the build logs for detailed error information.*`;
          
          await github.rest.issues.createComment({
            owner,
            repo,
            issue_number: issueNumber,
            body: message
          });
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.artifact.outputs.name }}
        path: |
          dist/
          !dist/**/*.spec
        retention-days: 30
        
  release:
    if: github.event_name == 'release'
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: "WALRIO_*-*"
        merge-multiple: false
      
    - name: Create release archives
      run: |
        # Create archives for each variant and platform
        for artifact_dir in */; do
          if [ -d "$artifact_dir" ]; then
            # Remove trailing slash
            dir_name="${artifact_dir%/}"
            
            # Skip if not our artifact naming pattern
            if [[ ! "$dir_name" =~ ^WALRIO_(MAIN|LITE)-(linux|macos|windows)$ ]]; then
              continue
            fi
            
            # Create appropriate archive format
            if [[ "$dir_name" == *"windows"* ]]; then
              # Windows: create .zip files
              cd "$artifact_dir"
              zip -r "../${dir_name}.zip" .
              cd ..
            else
              # Linux/macOS: create .tar.gz files  
              tar -czf "${dir_name}.tar.gz" -C "$artifact_dir" .
            fi
            
            echo "Created archive for $dir_name"
          fi
        done
        
        # List created archives
        ls -la *.zip *.tar.gz 2>/dev/null || echo "No archives created"
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          *.zip
          *.tar.gz
        draft: true
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}