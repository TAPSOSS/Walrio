name: Build Walrio GUIs

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.11']  # Use latest compatible Python version
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    # Linux-specific setup
    - name: Install Linux dependencies
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gstreamer1.0-tools \
          gstreamer1.0-plugins-base \
          gstreamer1.0-plugins-good \
          gstreamer1.0-plugins-bad \
          gstreamer1.0-plugins-ugly \
          gstreamer1.0-libav \
          libgstreamer1.0-dev \
          libgirepository1.0-dev \
          gobject-introspection \
          libcairo2-dev \
          libgtk-3-dev \
          build-essential \
          python3-dev \
          pkg-config \
          libffi-dev
          
    # macOS-specific setup  
    - name: Install macOS dependencies
      if: runner.os == 'macOS'
      continue-on-error: true
      run: |
        echo "Installing macOS dependencies..."
        
        # Try to update brew (non-blocking)
        brew update || echo "Brew update failed, continuing..."
        
        # Install core GStreamer (retry on failure)
        echo "Installing GStreamer..."
        if ! brew install gstreamer gst-plugins-base; then
          echo "Core GStreamer installation failed, retrying once..."
          sleep 10
          brew install gstreamer gst-plugins-base || echo "GStreamer installation failed, continuing..."
        fi
        
        # Install additional plugins (optional, non-blocking)
        echo "Installing GStreamer plugins..."
        brew install gst-plugins-good gst-plugins-bad gst-plugins-ugly || echo "Some GStreamer plugins failed to install"
        
        # Install Python/GTK dependencies (optional, non-blocking)  
        echo "Installing Python/GTK dependencies..."
        brew install gobject-introspection gtk+3 || echo "GTK dependencies failed to install"
        
        echo "macOS dependency installation completed (some failures may be non-critical)"
        
    # Windows-specific setup
    - name: Install Windows dependencies  
      if: runner.os == 'Windows'
      run: |
        # Install latest GStreamer via Chocolatey (most reliable method)
        choco install gstreamer -y
        
    - name: Setup Windows build environment
      if: runner.os == 'Windows'
      run: |
        # Install Microsoft Visual C++ build tools which are needed for compiling Python extensions
        choco install visualstudio2022buildtools --package-parameters "--add Microsoft.VisualStudio.Workload.VCTools" -y
        # Install pkg-config for Windows
        choco install pkgconfiglite -y
        
    - name: Install Python dependencies (non-Linux)
      if: runner.os != 'Linux'
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Install Python dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        python -m pip install --upgrade pip
        # Install everything except PyGObject from requirements.txt
        pip install mutagen PySide6 Pillow
        pip install pyinstaller
        
    - name: Install additional build dependencies (non-Linux)
      if: runner.os != 'Linux'
      run: |
        pip install PySide6 mutagen PyGObject
        
    # Linux: Install PyGObject via system packages (more reliable)
    - name: Install PyGObject (Linux)
      if: runner.os == 'Linux'  
      run: |
        # Install PyGObject from system packages (already installed in Linux dependencies step)
        echo "PyGObject system packages already installed"
        # Verify installation
        python3 -c "import gi; print('PyGObject system installation successful')" || echo "PyGObject verification failed"
        
    - name: Run dependency check
      continue-on-error: true
      run: |
        python build_gui.py --no-deps-check --gui both --clean
        
    - name: Build GUIs
      run: |
        python build_gui.py --gui both --clean
        
    - name: Test built executables (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        # Test that executables were created and can show help
        if [ -f "dist/WalrioMain" ]; then
          echo "WalrioMain executable found"
          # Could add: timeout 10s ./dist/WalrioMain --help || true
        fi
        if [ -f "dist/WalrioLite" ]; then
          echo "WalrioLite executable found" 
          # Could add: timeout 10s ./dist/WalrioLite --help || true
        fi
        
    - name: Test built executables (Windows)
      if: runner.os == 'Windows'
      run: |
        if (Test-Path "dist/WalrioMain.exe") {
          Write-Host "WalrioMain.exe found"
        }
        if (Test-Path "dist/WalrioLite.exe") {
          Write-Host "WalrioLite.exe found"
        }
        
    - name: Create artifact name
      id: artifact
      run: |
        OS_NAME="${{ runner.os }}"
        if [ "$OS_NAME" = "Linux" ]; then
          OS_NAME="linux"
        elif [ "$OS_NAME" = "Windows" ]; then
          OS_NAME="windows"  
        elif [ "$OS_NAME" = "macOS" ]; then
          OS_NAME="macos"
        fi
        echo "name=walrio-${OS_NAME}" >> $GITHUB_OUTPUT
      shell: bash
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.artifact.outputs.name }}
        path: |
          dist/
          !dist/**/*.spec
        retention-days: 30
        
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: walrio-*
        merge-multiple: true
      
    - name: Create release archives
      run: |
        for dir in walrio-*; do
          if [ -d "$dir" ]; then
            if [[ "$dir" == *"windows"* ]]; then
              zip -r "${dir}.zip" "$dir"
            else
              tar -czf "${dir}.tar.gz" "$dir"
            fi
          fi
        done
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          *.zip
          *.tar.gz
        draft: true
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}