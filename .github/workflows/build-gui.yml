name: Build Walrio GUIs

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.11']  # Use latest compatible Python version
        gui-variant: ['main', 'lite']
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    # Linux-specific setup
    - name: Install Linux dependencies
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gstreamer1.0-tools \
          gstreamer1.0-plugins-base \
          gstreamer1.0-plugins-good \
          gstreamer1.0-plugins-bad \
          gstreamer1.0-plugins-ugly \
          gstreamer1.0-libav \
          libgstreamer1.0-dev \
          libgirepository1.0-dev \
          gobject-introspection \
          libcairo2-dev \
          libgtk-3-dev \
          build-essential \
          python3-dev \
          pkg-config \
          libffi-dev
          
    # macOS-specific setup  
    - name: Install macOS dependencies
      if: runner.os == 'macOS'
      run: |
        echo "Installing macOS dependencies..."
        
        # Update homebrew
        brew update
        
        # Install core system dependencies first (required for PyGObject compilation)
        echo "Installing core system dependencies..."
        brew install python3 gobject-introspection libffi pkg-config cairo glib gtk+3
        
        # Install GStreamer and plugins
        echo "Installing GStreamer..."
        brew install gstreamer gst-plugins-base gst-plugins-good gst-plugins-bad gst-plugins-ugly
        
        # Set up essential environment variables for PyGObject
        echo "Setting up environment variables..."
        
        # Get Homebrew prefix (handles both Intel and Apple Silicon)
        BREW_PREFIX=$(brew --prefix)
        
        # Set PKG_CONFIG_PATH for libffi and other libraries
        echo "PKG_CONFIG_PATH=${BREW_PREFIX}/lib/pkgconfig:${BREW_PREFIX}/libffi/lib/pkgconfig:\$PKG_CONFIG_PATH" >> $GITHUB_ENV
        
        # Set library paths for dynamic linking
        echo "DYLD_LIBRARY_PATH=${BREW_PREFIX}/lib:\$DYLD_LIBRARY_PATH" >> $GITHUB_ENV
        echo "LD_LIBRARY_PATH=${BREW_PREFIX}/lib:\$LD_LIBRARY_PATH" >> $GITHUB_ENV
        
        # Set GI typelib path
        echo "GI_TYPELIB_PATH=${BREW_PREFIX}/lib/girepository-1.0:\$GI_TYPELIB_PATH" >> $GITHUB_ENV
        
        # Set GST plugin path  
        echo "GST_PLUGIN_PATH=${BREW_PREFIX}/lib/gstreamer-1.0:\$GST_PLUGIN_PATH" >> $GITHUB_ENV
        
        # Export for current shell session
        export PKG_CONFIG_PATH="${BREW_PREFIX}/lib/pkgconfig:${BREW_PREFIX}/libffi/lib/pkgconfig:$PKG_CONFIG_PATH"
        export DYLD_LIBRARY_PATH="${BREW_PREFIX}/lib:$DYLD_LIBRARY_PATH"
        export GI_TYPELIB_PATH="${BREW_PREFIX}/lib/girepository-1.0:$GI_TYPELIB_PATH"
        
        echo "macOS dependency installation completed successfully"
        
    # Windows-specific setup
    - name: Install Windows dependencies  
      if: runner.os == 'Windows'
      run: |
        # Install GStreamer
        choco install gstreamer -y
        
        # Install MSYS2 - the officially recommended approach for PyGObject on Windows
        Write-Host "Installing MSYS2..."
        choco install msys2 -y
        
        # Initialize MSYS2 and install PyGObject
        Write-Host "Setting up PyGObject via MSYS2..."
        $env:PATH = "C:\tools\msys64\ucrt64\bin;C:\tools\msys64\usr\bin;" + $env:PATH
        
        # Update MSYS2 package database
        C:\tools\msys64\usr\bin\bash.exe -lc "pacman -Syu --noconfirm"
        
        # Install PyGObject and Python via MSYS2
        C:\tools\msys64\usr\bin\bash.exe -lc "pacman -S --noconfirm mingw-w64-ucrt-x86_64-python mingw-w64-ucrt-x86_64-python-gobject mingw-w64-ucrt-x86_64-gtk4"
        
        # Verify installation
        $msys2Python = "C:\tools\msys64\ucrt64\bin\python.exe"
        if (Test-Path $msys2Python) {
          Write-Host "MSYS2 Python found at: $msys2Python"
          & $msys2Python -c "import gi; print('PyGObject import successful')"
          Write-Host "PyGObject successfully installed via MSYS2"
        } else {
          Write-Host "MSYS2 Python installation failed, trying conda-forge fallback..."
          
          # Fallback to conda-forge
          try {
            choco install miniconda3 -y
            $env:PATH = "C:\tools\miniconda3;C:\tools\miniconda3\Scripts;C:\tools\miniconda3\condabin;" + $env:PATH
            refreshenv
            
            & C:\tools\miniconda3\Scripts\conda.exe config --set always_yes true
            & C:\tools\miniconda3\Scripts\conda.exe install -c conda-forge pygobject gtk
            
            Write-Host "PyGObject installed via conda-forge fallback"
          } catch {
            Write-Host "ERROR: All PyGObject installation methods failed"
            exit 1
          }
        }
        
    - name: Install Python dependencies (non-Linux)
      if: runner.os != 'Linux'
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Install Python dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        python -m pip install --upgrade pip
        # Install everything except PyGObject from requirements.txt
        pip install mutagen PySide6 Pillow
        pip install pyinstaller
        
    - name: Install additional build dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        # Install Python dependencies
        pip install PySide6 mutagen
        
        # Install PyGObject with proper environment
        echo "Installing PyGObject with proper environment setup..."
        
        # Ensure environment variables are available
        BREW_PREFIX=$(brew --prefix)
        export PKG_CONFIG_PATH="${BREW_PREFIX}/lib/pkgconfig:${BREW_PREFIX}/libffi/lib/pkgconfig:$PKG_CONFIG_PATH"
        export DYLD_LIBRARY_PATH="${BREW_PREFIX}/lib:$DYLD_LIBRARY_PATH"
        
        # Install PyGObject
        pip install PyGObject
        
        # Verify installation
        python3 -c "import gi; print('PyGObject import successful')"
        python3 -c "import gi; gi.require_version('GLib', '2.0'); from gi.repository import GLib; print('GLib import successful')"
        
    - name: Install additional build dependencies (Windows)
      if: runner.os == 'Windows'
      run: |
        # Check if MSYS2 Python is available
        $msys2Python = "C:\tools\msys64\ucrt64\bin\python.exe"
        if (Test-Path $msys2Python) {
          Write-Host "MSYS2 Python found, setting up environment for system Python to access MSYS2 PyGObject"
          
          # Add MSYS2 paths to system PATH for library discovery
          $env:PATH = "C:\tools\msys64\ucrt64\bin;C:\tools\msys64\usr\bin;" + $env:PATH
          
          # Set up library paths for PyGObject
          $env:PKG_CONFIG_PATH = "C:\tools\msys64\ucrt64\lib\pkgconfig"
          $env:GI_TYPELIB_PATH = "C:\tools\msys64\ucrt64\lib\girepository-1.0"
          
          # Add MSYS2 Python site-packages to system Python path
          $msys2SitePackages = "C:\tools\msys64\ucrt64\lib\python3.11\site-packages"
          $env:PYTHONPATH = "$msys2SitePackages;" + $env:PYTHONPATH
          
          # Persist environment variables for subsequent steps
          echo "PATH=C:\tools\msys64\ucrt64\bin;C:\tools\msys64\usr\bin;$env:PATH" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "PKG_CONFIG_PATH=C:\tools\msys64\ucrt64\lib\pkgconfig" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "GI_TYPELIB_PATH=C:\tools\msys64\ucrt64\lib\girepository-1.0" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "PYTHONPATH=$msys2SitePackages;$env:PYTHONPATH" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          
          # Use system Python with access to MSYS2 libraries
          pip install PySide6 mutagen pyinstaller
          
          # Test PyGObject import
          python -c "import gi; print('PyGObject import successful via MSYS2 path')"
          
          Write-Host "Configured system Python to use MSYS2 PyGObject"
        } else {
          Write-Host "Using system Python (conda fallback was used)"
          pip install PySide6 mutagen pyinstaller
        }
        
    # Linux: Install PyGObject via system packages (more reliable)
    - name: Install PyGObject (Linux)
      if: runner.os == 'Linux'  
      run: |
        # Install PyGObject from system packages (already installed in Linux dependencies step)
        echo "PyGObject system packages already installed"
        # Verify installation
        python3 -c "import gi; print('PyGObject system installation successful')" || echo "PyGObject verification failed"
        
    - name: Run dependency check
      continue-on-error: true
      run: |
        make deps-check
        
    - name: Build GUI (${{ matrix.gui-variant }})
      run: |
        make build-${{ matrix.gui-variant }}
        
    - name: Test built executable (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        # Test that the specific executable was created
        VARIANT="${{ matrix.gui-variant }}"
        if [ "$VARIANT" = "main" ]; then
          EXPECTED_FILE="dist/WalrioMain"
        else
          EXPECTED_FILE="dist/WalrioLite"
        fi
        
        if [ -f "$EXPECTED_FILE" ]; then
          echo "✓ $EXPECTED_FILE found"
        else
          echo "✗ $EXPECTED_FILE not found"
          ls -la dist/ || echo "dist/ directory not found"
          exit 1
        fi
        
    - name: Test built executable (Windows)
      if: runner.os == 'Windows'
      run: |
        $variant = "${{ matrix.gui-variant }}"
        if ($variant -eq "main") {
          $expectedFile = "dist/WalrioMain.exe"
        } else {
          $expectedFile = "dist/WalrioLite.exe"
        }
        
        if (Test-Path $expectedFile) {
          Write-Host "✓ $expectedFile found"
        } else {
          Write-Host "✗ $expectedFile not found"
          Get-ChildItem dist/ -ErrorAction SilentlyContinue | Format-Table
          exit 1
        }
        
    - name: Create artifact name
      id: artifact
      run: |
        OS_NAME="${{ runner.os }}"
        if [ "$OS_NAME" = "Linux" ]; then
          OS_NAME="linux"
        elif [ "$OS_NAME" = "Windows" ]; then
          OS_NAME="windows"  
        elif [ "$OS_NAME" = "macOS" ]; then
          OS_NAME="macos"
        fi
        
        VARIANT="${{ matrix.gui-variant }}"
        VARIANT_UPPER=$(echo "$VARIANT" | tr '[:lower:]' '[:upper:]')
        
        echo "name=WALRIO_${VARIANT_UPPER}-${OS_NAME}" >> $GITHUB_OUTPUT
      shell: bash
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.artifact.outputs.name }}
        path: |
          dist/
          !dist/**/*.spec
        retention-days: 30
        
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: "WALRIO_*-*"
        merge-multiple: false
      
    - name: Create release archives
      run: |
        # Create archives for each variant and platform
        for artifact_dir in */; do
          if [ -d "$artifact_dir" ]; then
            # Remove trailing slash
            dir_name="${artifact_dir%/}"
            
            # Skip if not our artifact naming pattern
            if [[ ! "$dir_name" =~ ^WALRIO_(MAIN|LITE)-(linux|macos|windows)$ ]]; then
              continue
            fi
            
            # Create appropriate archive format
            if [[ "$dir_name" == *"windows"* ]]; then
              # Windows: create .zip files
              cd "$artifact_dir"
              zip -r "../${dir_name}.zip" .
              cd ..
            else
              # Linux/macOS: create .tar.gz files  
              tar -czf "${dir_name}.tar.gz" -C "$artifact_dir" .
            fi
            
            echo "Created archive for $dir_name"
          fi
        done
        
        # List created archives
        ls -la *.zip *.tar.gz 2>/dev/null || echo "No archives created"
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          *.zip
          *.tar.gz
        draft: true
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}