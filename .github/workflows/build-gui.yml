name: Build Walrio GUIs

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.11']  # Use latest compatible Python version
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    # Linux-specific setup
    - name: Install Linux dependencies
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gstreamer1.0-tools \
          gstreamer1.0-plugins-base \
          gstreamer1.0-plugins-good \
          gstreamer1.0-plugins-bad \
          gstreamer1.0-plugins-ugly \
          gstreamer1.0-libav \
          libgstreamer1.0-dev \
          libgirepository1.0-dev \
          gobject-introspection \
          libcairo2-dev \
          libgtk-3-dev \
          build-essential \
          python3-dev \
          pkg-config \
          libffi-dev
          
    # macOS-specific setup  
    - name: Install macOS dependencies
      if: runner.os == 'macOS'
      continue-on-error: true
      run: |
        echo "Installing macOS dependencies..."
        
        # Try to update brew (non-blocking)
        brew update || echo "Brew update failed, continuing..."
        
        # Install core GStreamer (retry on failure)
        echo "Installing GStreamer..."
        if ! brew install gstreamer gst-plugins-base; then
          echo "Core GStreamer installation failed, retrying once..."
          sleep 10
          brew install gstreamer gst-plugins-base || echo "GStreamer installation failed, continuing..."
        fi
        
        # Install additional plugins (optional, non-blocking)
        echo "Installing GStreamer plugins..."
        brew install gst-plugins-good gst-plugins-bad gst-plugins-ugly || echo "Some GStreamer plugins failed to install"
        
        # Install Python/GTK dependencies (optional, non-blocking)  
        echo "Installing Python/GTK dependencies..."
        brew install gobject-introspection gtk+3 || echo "GTK dependencies failed to install"
        
        echo "macOS dependency installation completed (some failures may be non-critical)"
        
    # Windows-specific setup
    - name: Install Windows dependencies  
      if: runner.os == 'Windows'
      run: |
        # Install GStreamer
        choco install gstreamer -y
        
        # Install MSYS2 - the officially recommended approach for PyGObject on Windows
        Write-Host "Installing MSYS2..."
        choco install msys2 -y
        
        # Initialize MSYS2 and install PyGObject
        Write-Host "Setting up PyGObject via MSYS2..."
        $env:PATH = "C:\tools\msys64\ucrt64\bin;C:\tools\msys64\usr\bin;" + $env:PATH
        
        # Update MSYS2 package database
        C:\tools\msys64\usr\bin\bash.exe -lc "pacman -Syu --noconfirm"
        
        # Install PyGObject and Python via MSYS2
        C:\tools\msys64\usr\bin\bash.exe -lc "pacman -S --noconfirm mingw-w64-ucrt-x86_64-python mingw-w64-ucrt-x86_64-python-gobject mingw-w64-ucrt-x86_64-gtk4"
        
        # Verify installation
        $msys2Python = "C:\tools\msys64\ucrt64\bin\python.exe"
        if (Test-Path $msys2Python) {
          Write-Host "MSYS2 Python found at: $msys2Python"
          & $msys2Python -c "import gi; print('PyGObject import successful')"
          Write-Host "PyGObject successfully installed via MSYS2"
        } else {
          Write-Host "MSYS2 Python installation failed, trying conda-forge fallback..."
          
          # Fallback to conda-forge
          try {
            choco install miniconda3 -y
            $env:PATH = "C:\tools\miniconda3;C:\tools\miniconda3\Scripts;C:\tools\miniconda3\condabin;" + $env:PATH
            refreshenv
            
            & C:\tools\miniconda3\Scripts\conda.exe config --set always_yes true
            & C:\tools\miniconda3\Scripts\conda.exe install -c conda-forge pygobject gtk
            
            Write-Host "PyGObject installed via conda-forge fallback"
          } catch {
            Write-Host "ERROR: All PyGObject installation methods failed"
            exit 1
          }
        }
        
    - name: Install Python dependencies (non-Linux)
      if: runner.os != 'Linux'
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Install Python dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        python -m pip install --upgrade pip
        # Install everything except PyGObject from requirements.txt
        pip install mutagen PySide6 Pillow
        pip install pyinstaller
        
    - name: Install additional build dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        pip install PySide6 mutagen PyGObject
        
    - name: Install additional build dependencies (Windows)
      if: runner.os == 'Windows'
      run: |
        # Check if MSYS2 Python is available
        $msys2Python = "C:\tools\msys64\ucrt64\bin\python.exe"
        if (Test-Path $msys2Python) {
          Write-Host "Using MSYS2 Python environment"
          # Install dependencies in MSYS2 environment
          C:\tools\msys64\usr\bin\bash.exe -lc "pacman -S --noconfirm mingw-w64-ucrt-x86_64-python-pip"
          & $msys2Python -m pip install PySide6 mutagen pyinstaller
          
          # Set up Python path for subsequent steps
          $env:PYTHON_EXECUTABLE = $msys2Python
          echo "PYTHON_EXECUTABLE=$msys2Python" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        } else {
          Write-Host "Using system Python (conda fallback was used)"
          pip install PySide6 mutagen
        }
        
    # Linux: Install PyGObject via system packages (more reliable)
    - name: Install PyGObject (Linux)
      if: runner.os == 'Linux'  
      run: |
        # Install PyGObject from system packages (already installed in Linux dependencies step)
        echo "PyGObject system packages already installed"
        # Verify installation
        python3 -c "import gi; print('PyGObject system installation successful')" || echo "PyGObject verification failed"
        
    - name: Run dependency check
      continue-on-error: true
      run: |
        if [ "${{ runner.os }}" = "Windows" ] && [ -n "$PYTHON_EXECUTABLE" ]; then
          echo "Using MSYS2 Python for dependency check: $PYTHON_EXECUTABLE"
          "$PYTHON_EXECUTABLE" build_gui.py --no-deps-check --gui both --clean
        else
          python build_gui.py --no-deps-check --gui both --clean
        fi
      shell: bash
        
    - name: Build GUIs
      run: |
        if [ "${{ runner.os }}" = "Windows" ] && [ -n "$PYTHON_EXECUTABLE" ]; then
          echo "Using MSYS2 Python: $PYTHON_EXECUTABLE"
          "$PYTHON_EXECUTABLE" build_gui.py --gui both --clean
        else
          python build_gui.py --gui both --clean
        fi
      shell: bash
        
    - name: Test built executables (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        # Test that executables were created and can show help
        if [ -f "dist/WalrioMain" ]; then
          echo "WalrioMain executable found"
          # Could add: timeout 10s ./dist/WalrioMain --help || true
        fi
        if [ -f "dist/WalrioLite" ]; then
          echo "WalrioLite executable found" 
          # Could add: timeout 10s ./dist/WalrioLite --help || true
        fi
        
    - name: Test built executables (Windows)
      if: runner.os == 'Windows'
      run: |
        if (Test-Path "dist/WalrioMain.exe") {
          Write-Host "WalrioMain.exe found"
        }
        if (Test-Path "dist/WalrioLite.exe") {
          Write-Host "WalrioLite.exe found"
        }
        
    - name: Create artifact name
      id: artifact
      run: |
        OS_NAME="${{ runner.os }}"
        if [ "$OS_NAME" = "Linux" ]; then
          OS_NAME="linux"
        elif [ "$OS_NAME" = "Windows" ]; then
          OS_NAME="windows"  
        elif [ "$OS_NAME" = "macOS" ]; then
          OS_NAME="macos"
        fi
        echo "name=walrio-${OS_NAME}" >> $GITHUB_OUTPUT
      shell: bash
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.artifact.outputs.name }}
        path: |
          dist/
          !dist/**/*.spec
        retention-days: 30
        
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: walrio-*
        merge-multiple: true
      
    - name: Create release archives
      run: |
        for dir in walrio-*; do
          if [ -d "$dir" ]; then
            if [[ "$dir" == *"windows"* ]]; then
              zip -r "${dir}.zip" "$dir"
            else
              tar -czf "${dir}.tar.gz" "$dir"
            fi
          fi
        done
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          *.zip
          *.tar.gz
        draft: true
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}