name: Build Walrio GUIs

on:
  # Temporarily enable for all PR events to test and fix build issues
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write
  actions: read

jobs:
  build:
    # Temporarily run on all triggers to test and fix build process
    
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        gui-variant: ['main', 'lite']
    
    runs-on: ${{ matrix.os }}
    
    env:
      PYTHON_VERSION: '3.11'  # Fixed Python version for all builds
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    # Install GStreamer and PyGObject using system package managers (more reliable)
    - name: Install GStreamer and PyGObject (Linux)
      if: runner.os == 'Linux'
      run: |
        echo "Installing GStreamer and PyGObject for Linux..."
        sudo apt update
        sudo apt install -y \
          python3-gi \
          gir1.2-gstreamer-1.0 \
          gir1.2-gst-plugins-base-1.0 \
          gstreamer1.0-plugins-good \
          gstreamer1.0-plugins-bad \
          gstreamer1.0-plugins-ugly \
          gstreamer1.0-libav \
          libgirepository1.0-dev \
          libcairo2-dev \
          pkg-config \
          python3-dev
          
    - name: Install GStreamer and PyGObject (macOS)
      if: runner.os == 'macOS'
      run: |
        echo "Installing GStreamer and PyGObject for macOS..."
        brew update
        # Install GStreamer and PyGObject together
        brew install gstreamer gst-plugins-base gst-plugins-good gst-plugins-bad gst-plugins-ugly
        brew install gobject-introspection libffi pkg-config cairo glib gtk+3
        
    - name: Install GStreamer and PyGObject (Windows)  
      if: runner.os == 'Windows'
      run: |
        Write-Host "Installing GStreamer and PyGObject for Windows via MSYS2..."
        
        # Install MSYS2 - most reliable way to get both GStreamer and PyGObject on Windows
        Write-Host "Installing MSYS2..."
        choco install msys2 -y --force
        Start-Sleep -Seconds 10
        
        # Update MSYS2 and install both GStreamer and PyGObject
        Write-Host "Installing GStreamer and PyGObject via MSYS2..."
        C:\tools\msys64\usr\bin\bash.exe -lc "pacman -Syu --noconfirm"
        C:\tools\msys64\usr\bin\bash.exe -lc "pacman -S --noconfirm mingw-w64-x86_64-python mingw-w64-x86_64-python-gobject mingw-w64-x86_64-gstreamer mingw-w64-x86_64-gst-plugins-base mingw-w64-x86_64-gst-plugins-good mingw-w64-x86_64-gst-plugins-bad mingw-w64-x86_64-gst-plugins-ugly"
        
        # Set up environment variables for current session and future steps
        $env:PATH = "C:\tools\msys64\mingw64\bin;" + $env:PATH
        $env:PKG_CONFIG_PATH = "C:\tools\msys64\mingw64\lib\pkgconfig"
        $env:GI_TYPELIB_PATH = "C:\tools\msys64\mingw64\lib\girepository-1.0"
        $env:GST_PLUGIN_PATH = "C:\tools\msys64\mingw64\lib\gstreamer-1.0"
        
        # Save environment variables for future steps  
        echo "PATH=C:\tools\msys64\mingw64\bin;${env:PATH}" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        echo "PKG_CONFIG_PATH=C:\tools\msys64\mingw64\lib\pkgconfig" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append  
        echo "GI_TYPELIB_PATH=C:\tools\msys64\mingw64\lib\girepository-1.0" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        echo "GST_PLUGIN_PATH=C:\tools\msys64\mingw64\lib\gstreamer-1.0" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        
        Write-Host "Windows GStreamer and PyGObject installation completed"
        
        # Test PyGObject import right after installation (while environment is available)
        Write-Host "Testing PyGObject installation..."
        python -c "import gi; print('SUCCESS: PyGObject import successful')"
        python -c "import gi; gi.require_version('Gst', '1.0'); from gi.repository import Gst; print('SUCCESS: GStreamer import successful')"
        Write-Host "PyGObject verification passed in Windows installation step"

    - name: Comprehensive GStreamer verification (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        echo "=== Comprehensive GStreamer/PyGObject Verification ==="
        
        # Print environment variables
        echo "Environment variables:"
        echo "  GST_PLUGIN_PATH: ${GST_PLUGIN_PATH:-Not set}"
        echo "  GI_TYPELIB_PATH: ${GI_TYPELIB_PATH:-Not set}"
        echo "  PKG_CONFIG_PATH: ${PKG_CONFIG_PATH:-Not set}"
        
        # Test basic Python imports
        echo "Testing Python gi import..."
        python -c "import sys; print('Python version:', sys.version)"
        
        echo "Testing PyGObject import..."
        python -c "import gi; print('SUCCESS: gi import successful')" || echo "ERROR: gi import failed"
        
        echo "Testing GStreamer import..."
        python -c "import gi; gi.require_version('Gst', '1.0'); from gi.repository import Gst; print('SUCCESS: GStreamer import successful')" || echo "ERROR: GStreamer import failed"
        
        echo "Testing GStreamer initialization..."
        python -c "import gi; gi.require_version('Gst', '1.0'); from gi.repository import Gst; result = Gst.init_check(None); print('SUCCESS: GStreamer initialization successful' if result else 'WARNING: GStreamer initialization failed')" || echo "ERROR: GStreamer initialization test failed"
        
        echo "Verification completed."
        
    - name: Comprehensive GStreamer verification (Windows)
      if: runner.os == 'Windows'
      run: |
        Write-Host "=== Windows GStreamer/PyGObject Verification ==="
        
        # Set up MSYS2 environment for this step
        $env:PATH = "C:\tools\msys64\mingw64\bin;" + $env:PATH
        $env:PKG_CONFIG_PATH = "C:\tools\msys64\mingw64\lib\pkgconfig"
        $env:GI_TYPELIB_PATH = "C:\tools\msys64\mingw64\lib\girepository-1.0"
        $env:GST_PLUGIN_PATH = "C:\tools\msys64\mingw64\lib\gstreamer-1.0"
        
        # Print environment variables
        Write-Host "Environment variables:"
        Write-Host "  GST_PLUGIN_PATH: $env:GST_PLUGIN_PATH"
        Write-Host "  GI_TYPELIB_PATH: $env:GI_TYPELIB_PATH"
        Write-Host "  PKG_CONFIG_PATH: $env:PKG_CONFIG_PATH"
        
        # Test basic Python imports
        Write-Host "Testing Python gi import..."
        python -c "import sys; print('Python version:', sys.version)"
        
        Write-Host "Testing PyGObject import..."
        try {
          python -c "import gi; print('SUCCESS: gi import successful')"
        } catch {
          Write-Host "ERROR: gi import failed - $($_.Exception.Message)"
        }
        
        Write-Host "Testing GStreamer import..."
        try {
          python -c "import gi; gi.require_version('Gst', '1.0'); from gi.repository import Gst; print('SUCCESS: GStreamer import successful')"
        } catch {
          Write-Host "ERROR: GStreamer import failed - $($_.Exception.Message)"
        }
        
        Write-Host "Testing GStreamer initialization..."
        try {
          python -c "import gi; gi.require_version('Gst', '1.0'); from gi.repository import Gst; result = Gst.init_check(None); print('SUCCESS: GStreamer initialization successful' if result else 'WARNING: GStreamer initialization failed')"
        } catch {
          Write-Host "ERROR: GStreamer initialization test failed - $($_.Exception.Message)"
        }
        
        Write-Host "Windows verification completed."
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        # Install everything except PyGObject from requirements.txt (PyGObject handled separately)
        pip install mutagen PySide6 Pillow
        pip install pyinstaller
        



        
    - name: Run dependency check
      continue-on-error: true
      run: |
        make deps-check
        
    - name: Build GUI (${{ matrix.gui-variant }})
      run: |
        make build-${{ matrix.gui-variant }}
        
    - name: Test built executable (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        # Test that the specific executable was created
        VARIANT="${{ matrix.gui-variant }}"
        if [ "$VARIANT" = "main" ]; then
          EXPECTED_FILE="dist/WalrioMain"
        else
          EXPECTED_FILE="dist/WalrioLite"
        fi
        
        if [ -f "$EXPECTED_FILE" ]; then
          echo "SUCCESS: $EXPECTED_FILE found"
        else
          echo "ERROR: $EXPECTED_FILE not found"
          ls -la dist/ || echo "dist/ directory not found"
          exit 1
        fi
        
    - name: Test built executable (Windows)
      if: runner.os == 'Windows'
      run: |
        $variant = "${{ matrix.gui-variant }}"
        if ($variant -eq "main") {
          $expectedFile = "dist/WalrioMain.exe"
        } else {
          $expectedFile = "dist/WalrioLite.exe"
        }
        
        if (Test-Path $expectedFile) {
          Write-Host "SUCCESS: $expectedFile found"
        } else {
          Write-Host "ERROR: $expectedFile not found"
          Get-ChildItem dist/ -ErrorAction SilentlyContinue | Format-Table
          exit 1
        }
    
    - name: Test PyGObject bundling
      continue-on-error: true
      run: |
        echo "Testing PyGObject import capability in built environment..."
        
        # Test if gi can be imported in the current Python environment
        if python -c "import gi; print('SUCCESS: gi import successful')"; then
          echo "SUCCESS: PyGObject available in build environment"
        else
          echo "WARNING: PyGObject not available in build environment - executable may have import issues"
        fi
        
        # Additional GStreamer test
        if python -c "import gi; gi.require_version('Gst', '1.0'); from gi.repository import Gst; print('SUCCESS: GStreamer import successful')"; then
          echo "SUCCESS: GStreamer available in build environment"
        else
          echo "WARNING: GStreamer not available in build environment - audio may not work"
        fi
        
    - name: Create artifact name
      id: artifact
      run: |
        OS_NAME="${{ runner.os }}"
        if [ "$OS_NAME" = "Linux" ]; then
          OS_NAME="linux"
        elif [ "$OS_NAME" = "Windows" ]; then
          OS_NAME="windows"  
        elif [ "$OS_NAME" = "macOS" ]; then
          OS_NAME="macos"
        fi
        
        VARIANT="${{ matrix.gui-variant }}"
        VARIANT_UPPER=$(echo "$VARIANT" | tr '[:lower:]' '[:upper:]')
        
        echo "name=WALRIO_${VARIANT_UPPER}-${OS_NAME}" >> $GITHUB_OUTPUT
      shell: bash

    - name: Update build completion status
      if: github.event_name == 'issue_comment'
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const issueNumber = context.issue.number;
          const runId = '${{ github.run_id }}';
          const variant = '${{ matrix.gui-variant }}';
          const os = '${{ matrix.os }}';
          const artifactName = '${{ steps.artifact.outputs.name }}';
          
          const message = `âœ… **Build completed for ${variant} on ${os}**
          
          ðŸ“¦ Successfully built Walrio ${variant} GUI for ${os}
          
          ï¿½ **Artifact**: \`${artifactName}\`
          ðŸ”— **[Download from Actions](https://github.com/${owner}/${repo}/actions/runs/${runId})**
          
          *This build is complete and artifacts are ready for download.*`;
          
          await github.rest.issues.createComment({
            owner,
            repo,
            issue_number: issueNumber,
            body: message
          });

    - name: Comment on build failure
      if: failure() && github.event_name == 'issue_comment'
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const issueNumber = context.issue.number;
          const runId = '${{ github.run_id }}';
          const variant = '${{ matrix.gui-variant }}';
          const os = '${{ matrix.os }}';
          
          const message = `âŒ **Build failed for ${variant} on ${os}**
          
          ðŸ’¥ Failed to build Walrio ${variant} GUI for ${os}
          
          ðŸ” **[View error logs](https://github.com/${owner}/${repo}/actions/runs/${runId})**
          
          *Please check the build logs for detailed error information.*`;
          
          await github.rest.issues.createComment({
            owner,
            repo,
            issue_number: issueNumber,
            body: message
          });
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.artifact.outputs.name }}
        path: |
          dist/
          !dist/**/*.spec
        retention-days: 30
        
  release:
    if: github.event_name == 'release'
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: "WALRIO_*-*"
        merge-multiple: false
      
    - name: Create release archives
      run: |
        # Create archives for each variant and platform
        for artifact_dir in */; do
          if [ -d "$artifact_dir" ]; then
            # Remove trailing slash
            dir_name="${artifact_dir%/}"
            
            # Skip if not our artifact naming pattern
            if [[ ! "$dir_name" =~ ^WALRIO_(MAIN|LITE)-(linux|macos|windows)$ ]]; then
              continue
            fi
            
            # Create appropriate archive format
            if [[ "$dir_name" == *"windows"* ]]; then
              # Windows: create .zip files
              cd "$artifact_dir"
              zip -r "../${dir_name}.zip" .
              cd ..
            else
              # Linux/macOS: create .tar.gz files  
              tar -czf "${dir_name}.tar.gz" -C "$artifact_dir" .
            fi
            
            echo "Created archive for $dir_name"
          fi
        done
        
        # List created archives
        ls -la *.zip *.tar.gz 2>/dev/null || echo "No archives created"
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          *.zip
          *.tar.gz
        draft: true
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}